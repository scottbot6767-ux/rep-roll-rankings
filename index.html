<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rep Roll — Sales Craps</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #14141e;
      --surface-2: #1c1c28;
      --felt: #0d3d1a;
      --felt-mid: #0f4a1f;
      --felt-light: #1a6030;
      --felt-line: rgba(255,255,255,0.15);
      --felt-line-bright: rgba(255,255,255,0.35);
      --rail: #1a0f00;
      --rail-border: #3d2800;
      --gold: #c9a227;
      --gold-light: #e0b840;
      --gold-dim: #7a6010;
      --red: #c0392b;
      --red-bright: #e74c3c;
      --text: #f0ede8;
      --text-dim: #8a8a9a;
      --win: #27ae60;
      --loss: #c0392b;
      --token-size: 38px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===================== HEADER ===================== */
    header {
      background: var(--surface);
      border-bottom: 3px solid var(--gold);
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.2rem;
      color: var(--gold);
      letter-spacing: 0.06em;
      line-height: 1;
    }

    .logo span {
      display: block;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .payout-legend {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .payout-pill {
      background: var(--surface-2);
      border: 1px solid #2a2a3a;
      border-radius: 4px;
      padding: 3px 9px;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .payout-pill .num { color: var(--text-dim); }
    .payout-pill .pay { color: var(--gold); }

    .conn-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--text-dim);
    }

    .conn-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--win); }
    .conn-dot.off { background: var(--loss); }

    /* ===================== MY REP BAR ===================== */
    .my-rep-bar {
      background: var(--surface-2);
      border-bottom: 1px solid #1e1e2e;
      padding: 0.6rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .my-rep-bar label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .my-rep-bar select {
      background: var(--surface);
      border: 1px solid #333;
      border-radius: 4px;
      padding: 0.35rem 0.6rem;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      min-width: 150px;
    }

    .my-rep-bar select:focus { outline: none; border-color: var(--gold); }

    .my-rep-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.82rem;
    }

    .rep-dot { width: 9px; height: 9px; border-radius: 50%; }

    .free-tokens-badge {
      background: var(--gold);
      color: var(--bg);
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* ===================== TABLE WRAPPER ===================== */
    .table-section {
      padding: 1.5rem 2rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* The actual casino table */
    .craps-table {
      background: var(--felt);
      border-radius: 20px;
      border: 14px solid var(--rail);
      box-shadow:
        0 0 0 3px var(--rail-border),
        inset 0 0 80px rgba(0,0,0,0.4),
        0 20px 60px rgba(0,0,0,0.6);
      overflow: hidden;
      position: relative;
    }

    /* Top decorative rail with diamonds */
    .table-rail {
      background: var(--rail);
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      border-bottom: 2px solid var(--rail-border);
    }

    .rail-diamond {
      width: 10px;
      height: 10px;
      background: var(--gold);
      transform: rotate(45deg);
      opacity: 0.7;
    }

    .rail-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 0.3em;
      color: var(--gold);
      opacity: 0.8;
      padding: 0 1rem;
    }

    /* ---- COME section ---- */
    .come-section {
      background: var(--felt-mid);
      border-bottom: 2px solid var(--felt-line);
      padding: 0.5rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .section-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--felt-line-bright);
      white-space: nowrap;
      writing-mode: horizontal-tb;
    }

    /* ---- PLACE BETS section ---- */
    .place-section {
      border-bottom: 3px solid var(--felt-line-bright);
      position: relative;
    }

    .place-header {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.25em;
      color: var(--felt-line-bright);
      text-align: center;
      padding: 0.4rem 0 0;
    }

    .place-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0;
    }

    .place-cell {
      border-right: 2px solid var(--felt-line);
      border-bottom: 2px solid var(--felt-line);
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0.8rem 0.5rem 0.5rem;
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }

    .place-cell:last-child { border-right: none; }

    .place-cell:hover { background: rgba(255,255,255,0.06); }
    .place-cell.can-bet { background: rgba(52,152,219,0.08); }
    .place-cell.can-bet:hover { background: rgba(52,152,219,0.14); }

    .place-cell.six, .place-cell.eight {
      background: rgba(201,162,39,0.04);
    }

    .cell-number {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3.5rem;
      line-height: 1;
      color: var(--text);
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .place-cell.six .cell-number,
    .place-cell.eight .cell-number {
      color: var(--gold-light);
    }

    .cell-word {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.85rem;
      letter-spacing: 0.25em;
      color: var(--felt-line-bright);
      margin-top: -4px;
    }

    .cell-payout {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-top: 2px;
    }

    .cell-prob {
      font-size: 0.58rem;
      color: rgba(255,255,255,0.3);
    }

    .tokens-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      justify-content: center;
      margin-top: auto;
      padding-top: 0.4rem;
    }

    .token {
      width: var(--token-size);
      height: var(--token-size);
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      font-weight: 700;
      color: #000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      transition: transform 0.15s;
    }

    .token:hover { transform: scale(1.1); }

    /* ---- FIELD section ---- */
    .field-section {
      border-bottom: 3px solid var(--felt-line-bright);
      background: var(--felt-mid);
    }

    .field-inner {
      display: flex;
      align-items: stretch;
    }

    .field-label-box {
      width: 90px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 2px solid var(--felt-line);
      padding: 0.5rem;
    }

    .field-label-text {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      color: var(--felt-line-bright);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
    }

    .field-cells {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      flex: 1;
    }

    .field-cell {
      border-right: 2px solid var(--felt-line);
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0.6rem 0.4rem 0.4rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .field-cell:last-child { border-right: none; }
    .field-cell:hover { background: rgba(255,255,255,0.06); }
    .field-cell.can-bet { background: rgba(52,152,219,0.08); }

    .field-cell.double {
      background: rgba(192,57,43,0.08);
    }

    .field-cell.double .cell-number { color: var(--red-bright); }

    .field-num {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.4rem;
      line-height: 1;
      color: var(--text);
    }

    .field-double-label {
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--red-bright);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    /* ---- PROPS / CENTER section ---- */
    .props-section {
      border-bottom: 3px solid var(--felt-line-bright);
      background: var(--felt);
    }

    .props-inner {
      display: flex;
      align-items: stretch;
    }

    .props-label-box {
      width: 90px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 2px solid var(--felt-line);
    }

    .props-cells {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr 1fr 1fr;
      flex: 1;
    }

    .prop-cell {
      border-right: 2px solid var(--felt-line);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0.5rem 0.4rem 0.4rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .prop-cell:last-child { border-right: none; }
    .prop-cell:hover { background: rgba(255,255,255,0.06); }
    .prop-cell.can-bet { background: rgba(52,152,219,0.08); }

    .prop-cell.seven {
      background: rgba(192,57,43,0.1);
      cursor: pointer;
    }

    .prop-cell.seven:hover {
      background: rgba(192,57,43,0.18);
    }

    .prop-cell.seven .prop-num { color: var(--red-bright); }

    .prop-num {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      line-height: 1;
      color: var(--text);
    }

    .prop-word {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      color: var(--felt-line-bright);
    }

    .prop-cell.seven .prop-word { color: rgba(231,76,60,0.7); }

    /* ---- PASS LINE ---- */
    .pass-line {
      background: var(--felt-light);
      padding: 0.7rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 2px solid var(--felt-line-bright);
    }

    .pass-line-text {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.5em;
      color: var(--felt-line-bright);
    }

    /* ===================== BOTTOM PANELS ===================== */
    .bottom-section {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 1.2rem;
      padding: 0 2rem 2rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    .panel {
      background: var(--surface);
      border: 1px solid #1e1e2e;
      border-radius: 8px;
      overflow: hidden;
    }

    .panel-head {
      background: var(--surface-2);
      padding: 0.65rem 1rem;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 0.1em;
      color: var(--gold);
      border-bottom: 1px solid #1e1e2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body { padding: 0.9rem; }

    .btn {
      background: var(--gold);
      border: none;
      border-radius: 4px;
      padding: 0.45rem 0.8rem;
      color: var(--bg);
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 0.82rem;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }

    .btn:hover:not(:disabled) { background: var(--gold-light); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-sm { padding: 3px 7px; font-size: 0.7rem; border-radius: 3px; }
    .btn-ghost { background: transparent; border: 1px solid #333; color: var(--text-dim); }
    .btn-ghost:hover:not(:disabled) { background: var(--surface-2); color: var(--text); }
    .btn-red { background: var(--red); color: white; }
    .btn-red:hover:not(:disabled) { background: var(--red-bright); }

    /* ---- REP CARDS ---- */
    .rep-list { display: flex; flex-direction: column; gap: 0.4rem; }

    .rep-card {
      background: var(--surface-2);
      border: 1px solid #1e1e2e;
      border-radius: 6px;
      padding: 0.55rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .rep-card.has-tokens { border-color: var(--gold-dim); }
    .rep-card.is-me { border-color: #2980b9; }

    .rep-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.75rem; color: #000; flex-shrink: 0;
    }

    .rep-info { flex: 1; min-width: 0; }
    .rep-name { font-weight: 700; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .rep-meta { font-size: 0.68rem; color: var(--text-dim); }
    .rep-meta .count { color: var(--gold); font-weight: 700; }
    .rep-earn { font-size: 0.8rem; color: var(--win); font-weight: 700; white-space: nowrap; }
    .rep-actions { display: flex; gap: 3px; }

    /* ---- DICE ---- */
    .dice-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.2rem;
    }

    .dice-wrap { display: flex; gap: 1.5rem; }

    .die {
      width: 72px; height: 72px;
      background: #f5f0e8;
      border-radius: 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      padding: 8px; gap: 4px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.3);
    }

    .die.rolling { animation: diceRoll 0.65s ease-out; }

    @keyframes diceRoll {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.12); }
      50% { transform: rotate(200deg) scale(0.88); }
      75% { transform: rotate(300deg) scale(1.06); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .dot { width: 100%; height: 100%; border-radius: 50%; background: #1a1a2a; }
    .dot.hidden { background: transparent; }

    .roll-btn {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.15em;
      background: var(--gold);
      border: none; border-radius: 6px;
      padding: 0.75rem 3rem;
      color: var(--bg); cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 4px 14px rgba(201,162,39,0.3);
    }

    .roll-btn:hover:not(:disabled) { background: var(--gold-light); transform: translateY(-2px); }
    .roll-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .roll-result { text-align: center; }
    .roll-result .total { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; line-height: 1; color: var(--gold); }
    .roll-result .sub { font-size: 0.82rem; color: var(--text-dim); margin-top: 0.3rem; }
    .roll-result .winner-name { color: var(--win); font-weight: 700; }

    /* ---- LEADERBOARD ---- */
    .leaderboard { display: flex; flex-direction: column; gap: 0.35rem; }

    .lb-row {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.45rem 0.65rem; background: var(--surface-2);
      border-radius: 5px; border: 1px solid #1e1e2e;
    }

    .lb-rank { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: var(--text-dim); width: 22px; text-align: center; }
    .lb-rank.gold { color: #f4c542; }
    .lb-rank.silver { color: #c0c0c0; }
    .lb-rank.bronze { color: #cd7f32; }
    .lb-name { flex: 1; font-weight: 700; font-size: 0.82rem; }
    .lb-earn { font-weight: 700; color: var(--win); font-size: 0.82rem; }

    .history-list { display: flex; flex-direction: column; gap: 0.3rem; max-height: 220px; overflow-y: auto; }
    .history-list::-webkit-scrollbar { width: 3px; }
    .history-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

    .history-entry {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.3rem 0.55rem; background: var(--surface-2); border-radius: 4px; font-size: 0.73rem;
    }

    .history-roll { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; color: var(--gold); width: 20px; text-align: center; }
    .history-detail { flex: 1; color: var(--text-dim); }
    .history-payout { color: var(--win); font-weight: 700; }
    .history-payout.none { color: var(--text-dim); }

    /* ===================== MODALS ===================== */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface); border: 2px solid var(--gold);
      border-radius: 10px; padding: 1.5rem; max-width: 380px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }

    .modal h3 {
      font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem;
      color: var(--gold); letter-spacing: 0.08em; margin-bottom: 1rem;
    }

    .modal-sub { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem; }
    .modal-sub strong { color: var(--text); }

    .form-group { margin-bottom: 0.85rem; }

    .form-group label {
      display: block; font-size: 0.72rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--text-dim); margin-bottom: 0.3rem;
    }

    .form-group input, .form-group select {
      width: 100%; background: var(--surface-2); border: 1px solid #333;
      border-radius: 4px; padding: 0.5rem 0.65rem; color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    }

    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); }

    .modal-actions { display: flex; gap: 0.5rem; margin-top: 1.1rem; }
    .modal-actions .btn { flex: 1; padding: 0.6rem; }

    .rep-pick-list { display: flex; flex-direction: column; gap: 0.35rem; max-height: 230px; overflow-y: auto; }

    .rep-pick-item {
      display: flex; align-items: center; gap: 0.65rem;
      padding: 0.55rem 0.75rem; background: var(--surface-2);
      border: 1px solid #333; border-radius: 6px; cursor: pointer;
      transition: border-color 0.12s;
    }

    .rep-pick-item:hover { border-color: var(--gold); }
    .rep-pick-item .pick-free { margin-left: auto; font-size: 0.72rem; color: var(--gold); font-weight: 700; }

    /* ===================== WIN FX ===================== */
    .win-flash {
      position: fixed; inset: 0; background: rgba(39,174,96,0.1);
      pointer-events: none; z-index: 200; opacity: 0; transition: opacity 0.3s;
    }
    .win-flash.show { opacity: 1; }

    #confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 250; }

    .win-banner {
      position: fixed; top: -130px; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 3px solid var(--gold); border-radius: 12px;
      padding: 1rem 2rem; text-align: center; z-index: 260;
      transition: top 0.4s cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6); min-width: 300px;
    }

    .win-banner.show { top: 24px; }
    .win-banner .banner-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 0.12em; color: var(--gold); }
    .win-banner .banner-winners { font-size: 0.88rem; color: var(--text); margin-top: 0.2rem; }
    .win-banner .banner-payout { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; color: var(--win); }

    /* ===================== LOADING ===================== */
    .loading-screen {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center; z-index: 300;
    }
    .loading-screen.hidden { display: none; }
    .spinner { width: 40px; height: 40px; border: 3px solid #222; border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 1100px) {
      .bottom-section { grid-template-columns: 1fr 1fr; }
      .bottom-section > :last-child { grid-column: 1/-1; }
    }

    @media (max-width: 700px) {
      .bottom-section { grid-template-columns: 1fr; padding: 0 1rem 1rem; }
      .table-section { padding: 1rem; }
      .payout-legend { display: none; }
      .cell-number { font-size: 2.2rem; }
      .place-cell { min-height: 110px; }
    }
  </style>
</head>
<body>

  <div class="win-flash" id="win-flash"></div>
  <canvas id="confetti-canvas"></canvas>
  <div class="win-banner" id="win-banner">
    <div class="banner-title">WINNER!</div>
    <div class="banner-winners" id="banner-winners"></div>
    <div class="banner-payout" id="banner-payout"></div>
  </div>

  <div class="loading-screen" id="loading-screen">
    <div style="text-align:center">
      <div class="spinner"></div>
      <div style="margin-top:1rem;font-family:'Bebas Neue',sans-serif;color:var(--gold);letter-spacing:0.1em">Entering the Casino...</div>
    </div>
  </div>

  <header>
    <div class="logo">REP ROLL <span>Sales Incentive Craps</span></div>
    <div class="payout-legend">
      <div class="payout-pill"><span class="num">7</span><span class="pay">$3</span></div>
      <div class="payout-pill"><span class="num">6/8</span><span class="pay">$5</span></div>
      <div class="payout-pill"><span class="num">5/9</span><span class="pay">$10</span></div>
      <div class="payout-pill"><span class="num">4/10</span><span class="pay">$15</span></div>
      <div class="payout-pill"><span class="num">3/11</span><span class="pay">$25</span></div>
      <div class="payout-pill"><span class="num">2/12</span><span class="pay">$75</span></div>
    </div>
    <div class="conn-badge">
      <div class="conn-dot" id="conn-dot"></div>
      <span id="conn-label">Connecting...</span>
    </div>
  </header>

  <!-- MY REP BAR -->
  <div class="my-rep-bar">
    <label>You are:</label>
    <select id="my-rep-select" onchange="onMyRepChange()">
      <option value="">-- Select your rep --</option>
    </select>
    <div class="my-rep-indicator" id="my-rep-indicator" style="display:none">
      <div class="rep-dot" id="my-rep-dot"></div>
      <span id="my-rep-free"></span>
      <span class="free-tokens-badge" id="my-rep-badge" style="display:none">BET NOW</span>
    </div>
    <span style="margin-left:auto;font-size:0.72rem;color:var(--text-dim)">Click any number on the table to place your bet</span>
  </div>

  <!-- ==================== THE TABLE ==================== -->
  <div class="table-section">
    <div class="craps-table">

      <!-- Top Rail -->
      <div class="table-rail">
        <div class="rail-diamond"></div>
        <div class="rail-diamond"></div>
        <div class="rail-diamond"></div>
        <div class="rail-title">REP ROLL — BETS STAY UNTIL 7</div>
        <div class="rail-diamond"></div>
        <div class="rail-diamond"></div>
        <div class="rail-diamond"></div>
      </div>

      <!-- COME section (decorative) -->
      <div class="come-section">
        <span class="section-label">COME</span>
      </div>

      <!-- PLACE BETS — 4 5 6 8 9 10 -->
      <div class="place-section">
        <div class="place-header">PLACE YOUR BETS</div>
        <div class="place-row" id="place-row"></div>
      </div>

      <!-- FIELD — 2 3 11 12 -->
      <div class="field-section">
        <div class="field-inner">
          <div class="field-label-box">
            <span class="field-label-text">FIELD</span>
          </div>
          <div class="field-cells" id="field-row"></div>
        </div>
      </div>

      <!-- PROPS — 2 3 7 11 12 center bets -->
      <div class="props-section">
        <div class="props-inner">
          <div class="props-label-box">
            <span class="section-label" style="font-size:0.9rem">PROPS</span>
          </div>
          <div class="props-cells" id="props-row"></div>
        </div>
      </div>

      <!-- PASS LINE -->
      <div class="pass-line">
        <span class="pass-line-text">PASS LINE</span>
      </div>

    </div>
  </div>

  <!-- ==================== BOTTOM PANELS ==================== -->
  <div class="bottom-section">

    <!-- TEAM -->
    <div class="panel">
      <div class="panel-head">
        Team
        <button class="btn btn-sm" onclick="openAddRepModal()">+ Rep</button>
      </div>
      <div class="panel-body">
        <div class="rep-list" id="rep-list">
          <div style="color:var(--text-dim);font-size:0.8rem;text-align:center;padding:1rem">Loading...</div>
        </div>
      </div>
    </div>

    <!-- DICE -->
    <div class="panel">
      <div class="panel-head">
        Roll
        <div style="display:flex;gap:0.4rem;align-items:center">
          <button class="btn btn-sm btn-ghost btn-red" id="clear-board-btn" onclick="clearBoard()" style="display:none;font-size:0.7rem">Clear Board</button>
          <button class="btn btn-sm btn-ghost" id="admin-toggle-btn" onclick="toggleAdmin()" style="font-size:0.7rem">
            Admin: OFF
          </button>
        </div>
      </div>
      <div class="dice-panel">
        <div class="dice-wrap">
          <div class="die" id="die1">
            <div class="dot hidden"></div><div class="dot hidden"></div><div class="dot hidden"></div>
            <div class="dot hidden"></div><div class="dot hidden"></div><div class="dot hidden"></div>
          </div>
          <div class="die" id="die2">
            <div class="dot hidden"></div><div class="dot hidden"></div><div class="dot hidden"></div>
            <div class="dot hidden"></div><div class="dot hidden"></div><div class="dot hidden"></div>
          </div>
        </div>
        <button class="roll-btn" id="roll-btn" onclick="rollDice()" disabled>ROLL THE DICE</button>
        <div id="roll-status" style="font-size:0.75rem;color:var(--text-dim);text-align:center;margin-top:-0.3rem">Enable admin to roll</div>
        <div class="roll-result" id="roll-result"></div>
      </div>
    </div>

    <!-- LEADERBOARD + HISTORY -->
    <div style="display:flex;flex-direction:column;gap:1rem">
      <div class="panel">
        <div class="panel-head">
          Leaderboard
          <button class="btn btn-sm btn-ghost btn-red" onclick="resetAll()">Reset</button>
        </div>
        <div class="panel-body">
          <div class="leaderboard" id="leaderboard">
            <div style="color:var(--text-dim);font-size:0.8rem;text-align:center">No earnings yet.</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">Roll History</div>
        <div class="panel-body" style="padding:0.65rem">
          <div class="history-list" id="history-list">
            <div style="color:var(--text-dim);font-size:0.75rem;text-align:center">No rolls yet.</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- MODALS -->
  <div class="modal-overlay" id="add-rep-modal">
    <div class="modal">
      <h3>Add Rep</h3>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="new-rep-name" placeholder="Jane Smith" maxlength="20" onkeydown="if(event.key==='Enter')addRep()">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('add-rep-modal')">Cancel</button>
        <button class="btn" onclick="addRep()">Add Rep</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="give-token-modal">
    <div class="modal">
      <h3>Award Token</h3>
      <div class="modal-sub" id="give-token-label">Awarding to <strong></strong></div>
      <div class="form-group">
        <label>Reason (optional)</label>
        <input type="text" id="token-reason" placeholder="Closed the Acme deal" maxlength="50">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('give-token-modal')">Cancel</button>
        <button class="btn" onclick="confirmGiveToken()">Give Token</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="bet-modal">
    <div class="modal">
      <h3>Bet on <span id="bet-modal-num"></span></h3>
      <div class="modal-sub">Payout: <strong id="bet-modal-payout"></strong> per token</div>
      <div class="rep-pick-list" id="rep-pick-list"></div>
      <div class="modal-actions" style="margin-top:0.7rem">
        <button class="btn btn-ghost" onclick="closeModal('bet-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== SUPABASE ====================
    const SUPABASE_URL = 'https://eadtaehsjzelskyjybwz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhZHRhZWhzanplbHNreWp5Ynd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTg5NTYsImV4cCI6MjA4NzQzNDk1Nn0.FB9pwYBTyFpUWTptYO2z6nhayM2Cif9DAbXEXmpRSCk';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PAYOUTS = { 2:75, 3:25, 4:15, 5:10, 6:5, 7:3, 8:5, 9:10, 10:15, 11:25, 12:75 };
    const PROBS   = { 2:'2.8%', 3:'5.6%', 4:'8.3%', 5:'11.1%', 6:'13.9%', 7:'16.7%', 8:'13.9%', 9:'11.1%', 10:'8.3%', 11:'5.6%', 12:'2.8%' };
    const WORDS   = { 6:'SIX', 8:'EIGHT' };
    const REP_COLORS = ['#e74c3c','#3498db','#9b59b6','#e67e22','#1abc9c','#e91e63','#00bcd4','#ff9800','#8bc34a','#f06292','#ffb300','#26c6da'];

    let reps=[], bets=[], history=[], myRepId=null, giveTokenRepId=null, rolling=false;
    let isAdmin = sessionStorage.getItem('rr-admin')==='true';

    function toggleAdmin() {
      if(isAdmin){
        isAdmin=false;
        sessionStorage.removeItem('rr-admin');
        updateAdminUI();
      } else {
        const pin = prompt('Enter admin PIN (default: 0000):');
        const stored = sessionStorage.getItem('rr-pin')||'0000';
        if(pin===null) return;
        if(pin===stored){
          isAdmin=true;
          sessionStorage.setItem('rr-admin','true');
          updateAdminUI();
        } else {
          alert('Wrong PIN.');
        }
      }
    }

    function updateAdminUI() {
      const btn=document.getElementById('admin-toggle-btn');
      btn.textContent=`Admin: ${isAdmin?'ON':'OFF'}`;
      btn.style.background=isAdmin?'var(--win)':'transparent';
      btn.style.color=isAdmin?'#000':'var(--text-dim)';
      btn.style.borderColor=isAdmin?'var(--win)':'#333';
      document.getElementById('clear-board-btn').style.display=isAdmin?'inline-flex':'none';
      updateRollBtn();
      renderReps();
    }

    async function clearBoard() {
      if(!confirm('Clear all bets off the board?')) return;
      await db.from('rr_bets').delete().neq('id',0);
    }

    function updateRollBtn() {
      const hasBets = bets.length > 0;
      const rollBtn = document.getElementById('roll-btn');
      const status = document.getElementById('roll-status');
      if(!isAdmin){
        rollBtn.disabled=true;
        status.textContent='Enable admin to roll';
        status.style.color='var(--text-dim)';
      } else if(!hasBets){
        rollBtn.disabled=true;
        status.textContent='Waiting for bets...';
        status.style.color='var(--text-dim)';
      } else {
        rollBtn.disabled=false;
        status.textContent=`${bets.reduce((s,b)=>s+b.tokens,0)} token${bets.reduce((s,b)=>s+b.tokens,0)!==1?'s':''} on the table`;
        status.style.color='var(--win)';
      }
    }

    // ==================== CONFETTI ====================
    const confCanvas = document.getElementById('confetti-canvas');
    const confCtx = confCanvas.getContext('2d');
    let confParticles = [], confFrame = null;

    function resizeConf() { confCanvas.width=window.innerWidth; confCanvas.height=window.innerHeight; }
    window.addEventListener('resize', resizeConf); resizeConf();

    function launchConfetti(colors=['#c9a227','#27ae60','#e74c3c','#3498db','#f0ede8','#e0b52e']) {
      confParticles = Array.from({length:200}, () => ({
        x: Math.random()*confCanvas.width, y: -10,
        w: 5+Math.random()*9, h: 9+Math.random()*7,
        color: colors[Math.floor(Math.random()*colors.length)],
        vx: (Math.random()-0.5)*7, vy: 2+Math.random()*5,
        rot: Math.random()*Math.PI*2, rotV: (Math.random()-0.5)*0.22,
        opacity: 1, shape: Math.random()>0.4?'rect':'circle'
      }));
      if(confFrame) cancelAnimationFrame(confFrame);
      animateConf();
    }

    function animateConf() {
      confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
      let alive=false;
      confParticles.forEach(p => {
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.13; p.rot+=p.rotV;
        if(p.y>confCanvas.height*0.75) p.opacity-=0.02;
        if(p.opacity<=0||p.y>confCanvas.height+20) return;
        alive=true;
        confCtx.save();
        confCtx.globalAlpha=Math.max(0,p.opacity);
        confCtx.translate(p.x,p.y); confCtx.rotate(p.rot);
        confCtx.fillStyle=p.color;
        if(p.shape==='circle'){confCtx.beginPath();confCtx.arc(0,0,p.w/2,0,Math.PI*2);confCtx.fill();}
        else confCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        confCtx.restore();
      });
      if(alive) confFrame=requestAnimationFrame(animateConf);
      else confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
    }

    function showWinBanner(winnersArr, totalPayout) {
      const b=document.getElementById('win-banner');
      document.getElementById('banner-winners').textContent=winnersArr.map(w=>w.name).join(' & ');
      document.getElementById('banner-payout').textContent=`+$${totalPayout}`;
      b.classList.add('show');
      setTimeout(()=>b.classList.remove('show'),3800);
    }

    // ==================== TABLE INIT ====================
    function initTable() {
      // PLACE: 4 5 6 8 9 10
      const placeRow = document.getElementById('place-row');
      [4,5,6,8,9,10].forEach(n => {
        const cell = document.createElement('div');
        const isSix = n===6, isEight = n===8;
        cell.className = `place-cell${isSix?' six':isEight?' eight':''}`;
        cell.id = `cell-${n}`;
        cell.innerHTML = `
          <div class="cell-number">${n}</div>
          ${WORDS[n] ? `<div class="cell-word">${WORDS[n]}</div>` : ''}
          <div class="cell-payout">PAYS $${PAYOUTS[n]}</div>
          <div class="cell-prob">${PROBS[n]}</div>
          <div class="tokens-zone" id="tokens-${n}"></div>
        `;
        cell.onclick = () => handleCellClick(n);
        placeRow.appendChild(cell);
      });

      // FIELD: 2 3 11 12
      const fieldRow = document.getElementById('field-row');
      [2,3,11,12].forEach(n => {
        const cell = document.createElement('div');
        const isDouble = n===2||n===12;
        cell.className = `field-cell${isDouble?' double':''}`;
        cell.id = `cell-${n}`;
        cell.innerHTML = `
          <div class="field-num">${n}</div>
          ${isDouble ? `<div class="field-double-label">TRIPLE</div>` : ''}
          <div class="cell-payout">PAYS $${PAYOUTS[n]}</div>
          <div class="cell-prob">${PROBS[n]}</div>
          <div class="tokens-zone" id="tokens-${n}"></div>
        `;
        cell.onclick = () => handleCellClick(n);
        fieldRow.appendChild(cell);
      });

      // PROPS: 2 3 7 11 12 — center bets, 7 is the danger
      const propsRow = document.getElementById('props-row');
      // We won't double-bet 2/3/11/12 here since they're in field — just show 7 prominently
      // Instead: show quick-bet shortcuts and 7
      const propNums = [
        {n:3, label:'ACE DEUCE'},
        {n:11, label:'YO'},
        {n:7, label:'SEVEN OUT', danger:true},
        {n:2, label:'SNAKE EYES'},
        {n:12, label:'BOX CARS'}
      ];
      propNums.forEach(({n, label, danger}) => {
        const cell = document.createElement('div');
        cell.className = `prop-cell${danger?' seven':''}`;
        cell.innerHTML = `
          <div class="prop-num">${n}</div>
          <div class="prop-word">${label}</div>
          <div class="cell-payout" style="font-size:0.58rem">$${PAYOUTS[n]}</div>
          <div class="tokens-zone" id="tokens-prop-${n}"></div>
        `;
        // Props section for 7 bets — these are separate cells that show tokens too
        // but we merge with the main cell id for token display
        cell.onclick = () => handleCellClick(n);
        propsRow.appendChild(cell);
      });
    }

    // ==================== LOAD / REALTIME ====================
    async function loadAll() {
      const [rR, bR, hR] = await Promise.all([
        db.from('rr_reps').select('*').order('id'),
        db.from('rr_bets').select('*').order('id'),
        db.from('rr_history').select('*').order('rolled_at',{ascending:false}).limit(50)
      ]);
      if(rR.error){console.error(rR.error);return;}
      reps=rR.data||[]; bets=bR.data||[]; history=hR.data||[];
      render();
      document.getElementById('loading-screen').classList.add('hidden');
    }

    function subscribeRealtime() {
      db.channel('rr-live')
        .on('postgres_changes',{event:'*',schema:'public',table:'rr_reps'},()=>loadAll())
        .on('postgres_changes',{event:'*',schema:'public',table:'rr_bets'},()=>loadAll())
        .on('postgres_changes',{event:'*',schema:'public',table:'rr_history'},()=>loadAll())
        .subscribe(status=>{
          const live=status==='SUBSCRIBED';
          document.getElementById('conn-dot').className=`conn-dot${live?'':' off'}`;
          document.getElementById('conn-label').textContent=live?'Live':'Reconnecting...';
        });
    }

    // ==================== RENDER ====================
    function render() {
      renderReps(); renderTable(); renderLeaderboard(); renderHistory(); renderMyRepBar(); updateRollBtn();
    }

    function getFreeTokens(id) {
      const r=reps.find(r=>r.id===id); if(!r) return 0;
      const placed=bets.filter(b=>b.rep_id===id).reduce((s,b)=>s+b.tokens,0);
      return r.tokens-placed;
    }

    function renderReps() {
      const list=document.getElementById('rep-list');
      if(!reps.length){list.innerHTML='<div style="color:var(--text-dim);font-size:0.8rem;text-align:center;padding:1rem">No reps yet.</div>';return;}
      list.innerHTML='';
      reps.forEach(rep=>{
        const free=getFreeTokens(rep.id), isMe=rep.id===myRepId;
        const el=document.createElement('div');
        el.className=`rep-card${free>0?' has-tokens':''}${isMe?' is-me':''}`;
        el.innerHTML=`
          <div class="rep-avatar" style="background:${rep.color}">${rep.name[0].toUpperCase()}</div>
          <div class="rep-info">
            <div class="rep-name">${rep.name}${isMe?' (you)':''}</div>
            <div class="rep-meta"><span class="count">${free}</span> token${free!==1?'s':''} free</div>
          </div>
          <div class="rep-earn">$${(rep.earnings||0).toFixed(0)}</div>
          <div class="rep-actions">
            <button class="btn btn-sm" onclick="openGiveTokenModal(${rep.id})" title="Sale!">+ Token</button>
            ${isAdmin ? `<button class="btn btn-sm btn-ghost" style="opacity:0.5;font-size:0.65rem;padding:3px 5px;border-color:#c0392b;color:#e74c3c" onclick="if(confirm('Remove ${rep.name}?'))removeRep(${rep.id})">rm</button>` : ''}
          </div>
        `;
        list.appendChild(el);
      });
    }

    function renderMyRepBar() {
      const sel=document.getElementById('my-rep-select');
      const cur=sel.value;
      sel.innerHTML='<option value="">-- Select your rep --</option>';
      reps.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.name;sel.appendChild(o);});
      if(cur) sel.value=cur;
      const ind=document.getElementById('my-rep-indicator');
      if(myRepId){
        const rep=reps.find(r=>r.id===myRepId);
        if(rep){
          const free=getFreeTokens(myRepId);
          document.getElementById('my-rep-dot').style.background=rep.color;
          document.getElementById('my-rep-free').textContent=free>0?`${free} token${free!==1?'s':''} ready to bet`:'No tokens — wait for a sale';
          const badge=document.getElementById('my-rep-badge');
          badge.style.display=free>0?'':'none';
          ind.style.display='flex';
          // Highlight cells
          document.querySelectorAll('.place-cell,.field-cell,.prop-cell').forEach(c=>c.classList.toggle('can-bet',free>0));
        }
      } else {
        ind.style.display='none';
        document.querySelectorAll('.place-cell,.field-cell,.prop-cell').forEach(c=>c.classList.remove('can-bet'));
      }
    }

    function renderTable() {
      document.querySelectorAll('.tokens-zone').forEach(z=>z.innerHTML='');
      bets.forEach(bet=>{
        const rep=reps.find(r=>r.id===bet.rep_id); if(!rep) return;
        // Tokens show in primary cell; also in props if it's 2/3/7/11/12
        const zones=[`tokens-${bet.number}`];
        if([2,3,7,11,12].includes(bet.number)) zones.push(`tokens-prop-${bet.number}`);
        zones.forEach(zid=>{
          const z=document.getElementById(zid); if(!z) return;
          for(let i=0;i<bet.tokens;i++){
            const t=document.createElement('div');
            t.className='token'; t.style.background=rep.color;
            t.title=`${rep.name} on ${bet.number}`;
            t.textContent=rep.name[0].toUpperCase();
            z.appendChild(t);
          }
        });
      });
    }

    function renderLeaderboard() {
      const lb=document.getElementById('leaderboard');
      const sorted=[...reps].sort((a,b)=>(b.earnings||0)-(a.earnings||0));
      if(!sorted.length||sorted.every(r=>!r.earnings)){lb.innerHTML='<div style="color:var(--text-dim);font-size:0.8rem;text-align:center">No earnings yet.</div>';return;}
      lb.innerHTML='';
      sorted.forEach((rep,i)=>{
        const rc=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        const el=document.createElement('div'); el.className='lb-row';
        el.innerHTML=`<div class="lb-rank ${rc}">${i+1}</div><div class="rep-avatar" style="background:${rep.color};width:22px;height:22px;font-size:0.65rem">${rep.name[0].toUpperCase()}</div><div class="lb-name">${rep.name}</div><div class="lb-earn">$${(rep.earnings||0).toFixed(0)}</div>`;
        lb.appendChild(el);
      });
    }

    function renderHistory() {
      const list=document.getElementById('history-list');
      if(!history.length){list.innerHTML='<div style="color:var(--text-dim);font-size:0.75rem;text-align:center">No rolls yet.</div>';return;}
      list.innerHTML='';
      history.forEach(e=>{
        const w=e.winners_json||[], total=w.reduce((s,x)=>s+x.payout,0);
        const el=document.createElement('div'); el.className='history-entry';
        const wt=w.length?w.map(x=>`${x.name} +$${x.payout}`).join(', '):(e.seven_out?'SEVEN OUT':'No winners');
        el.innerHTML=`<div class="history-roll" style="${e.seven_out?'color:var(--loss)':''}">${e.roll}</div><div class="history-detail">${wt}</div>${total>0?`<div class="history-payout">$${total}</div>`:`<div class="history-payout none">—</div>`}`;
        list.appendChild(el);
      });
    }

    // ==================== DICE ====================
    function updateDie(dieEl, value) {
      const dots=dieEl.querySelectorAll('.dot');
      dots.forEach(d=>{d.style.gridRow='';d.style.gridColumn='';d.className='dot hidden';});
      const pos={1:[[2,2]],2:[[1,3],[3,1]],3:[[1,3],[2,2],[3,1]],4:[[1,1],[1,3],[3,1],[3,3]],5:[[1,1],[1,3],[2,2],[3,1],[3,3]],6:[[1,1],[2,1],[3,1],[1,3],[2,3],[3,3]]};
      pos[value].forEach((p,i)=>{dots[i].className='dot';dots[i].style.gridRow=p[0];dots[i].style.gridColumn=p[1];});
    }

    async function rollDice() {
      if(rolling) return;
      rolling=true;
      document.getElementById('roll-btn').disabled=true;
      const d1=document.getElementById('die1'), d2=document.getElementById('die2');
      d1.classList.add('rolling'); d2.classList.add('rolling');
      let ticks=0;
      const iv=setInterval(()=>{
        updateDie(d1,Math.ceil(Math.random()*6));
        updateDie(d2,Math.ceil(Math.random()*6));
        if(++ticks>=8){
          clearInterval(iv);
          const v1=Math.ceil(Math.random()*6), v2=Math.ceil(Math.random()*6);
          updateDie(d1,v1); updateDie(d2,v2);
          d1.classList.remove('rolling'); d2.classList.remove('rolling');
          processRoll(v1+v2).finally(()=>{rolling=false;document.getElementById('roll-btn').disabled=false;});
        }
      },80);
    }

    async function processRoll(total) {
      const sevenOut=total===7;
      const betsOnNum=bets.filter(b=>b.number===total);
      const winners=[];

      for(const bet of betsOnNum){
        const rep=reps.find(r=>r.id===bet.rep_id); if(!rep) continue;
        const payout=PAYOUTS[total]*bet.tokens;
        winners.push({name:rep.name,repId:rep.id,payout,color:rep.color});
      }

      // Write earnings to DB
      for(const w of winners){
        const rep=reps.find(r=>r.id===w.repId);
        await db.from('rr_reps').update({earnings:(rep.earnings||0)+w.payout}).eq('id',w.repId);
      }

      // Remove winning bets
      if(betsOnNum.length) await db.from('rr_bets').delete().eq('number',total);

      // Seven out: wipe remaining bets AND burn placed tokens (they don't return to owner)
      if(sevenOut){
        const remainingBets=bets.filter(b=>b.number!==total);
        const tokensBurned={};
        for(const bet of remainingBets){ tokensBurned[bet.rep_id]=(tokensBurned[bet.rep_id]||0)+bet.tokens; }
        await db.from('rr_bets').delete().neq('id',0);
        for(const [repId,burned] of Object.entries(tokensBurned)){
          const rep=reps.find(r=>r.id===Number(repId));
          if(rep) await db.from('rr_reps').update({tokens:Math.max(0,(rep.tokens||0)-burned)}).eq('id',rep.id);
        }
      }

      // History
      await db.from('rr_history').insert({roll:total,seven_out:sevenOut,winners_json:winners.map(w=>({name:w.name,payout:w.payout}))});

      // Show result
      const resultEl=document.getElementById('roll-result');
      const totalPayout=winners.reduce((s,w)=>s+w.payout,0);

      if(sevenOut){
        resultEl.innerHTML=`<div class="total" style="color:var(--loss)">7</div><div class="sub" style="color:var(--loss)">SEVEN OUT — table cleared${winners.length?' &bull; '+winners.map(w=>`<span class="winner-name">${w.name}</span> +$${w.payout}`).join(' &bull; '):''}
</div>`;
        if(winners.length){launchConfetti(['#e74c3c','#c0392b','#e67e22','#f39c12']);showWinBanner(winners,totalPayout);}
      } else if(winners.length){
        launchConfetti(['#c9a227','#27ae60','#f0ede8',...winners.map(w=>w.color)]);
        showWinBanner(winners,totalPayout);
        document.getElementById('win-flash').classList.add('show');
        setTimeout(()=>document.getElementById('win-flash').classList.remove('show'),600);
        resultEl.innerHTML=`<div class="total" style="color:var(--win)">${total}</div><div class="sub">${winners.map(w=>`<span class="winner-name">${w.name}</span> wins <strong style="color:var(--win)">$${w.payout}</strong>`).join(' &bull; ')}</div>`;
      } else {
        resultEl.innerHTML=`<div class="total">${total}</div><div class="sub">No winners — bets stay on the table</div>`;
      }
    }

    // ==================== BETTING ====================
    function handleCellClick(num) {
      if(myRepId){
        const existingBet = bets.find(b=>b.rep_id===myRepId&&b.number===num);
        const free=getFreeTokens(myRepId);

        // Rep clicking a cell they already have tokens on — offer to remove/move
        if(existingBet){
          openMoveBetModal(myRepId, num, existingBet);
          return;
        }

        // Rep has free tokens — place bet
        if(free>0){
          if(free===1) placeBet(myRepId,num,1);
          else openQuantityModal(myRepId,num,free);
          return;
        }

        // No free tokens but has bets elsewhere — offer to move
        const anyBet = bets.find(b=>b.rep_id===myRepId);
        if(anyBet){
          openMoveBetModal(myRepId, anyBet.number, anyBet, num);
          return;
        }
      }
      openBetModal(num);
    }

    function openMoveBetModal(repId, fromNum, bet, toNum=null) {
      const rep=reps.find(r=>r.id===repId);
      document.getElementById('bet-modal-num').textContent=fromNum;
      document.getElementById('bet-modal-payout').textContent=`$${PAYOUTS[fromNum]}`;
      const list=document.getElementById('rep-pick-list');
      list.innerHTML=`
        <div style="padding:0.4rem 0;font-size:0.88rem;color:var(--text-dim)">
          <strong style="color:var(--text)">${rep.name}</strong> has ${bet.tokens} token${bet.tokens!==1?'s':''} on <strong style="color:var(--gold)">${fromNum}</strong>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.4rem;margin-top:0.4rem">
          ${toNum ? `
          <button class="btn" onclick="closeModal('bet-modal');moveBet(${repId},${fromNum},${toNum},${bet.tokens})">
            Move all ${bet.tokens} token${bet.tokens!==1?'s':''} to ${toNum}
          </button>` : ''}
          <button class="btn btn-ghost" style="border-color:#c0392b;color:#e74c3c" onclick="closeModal('bet-modal');removeBet(${repId},${fromNum})">
            Remove bet (return ${bet.tokens} token${bet.tokens!==1?'s':''})
          </button>
        </div>
      `;
      document.getElementById('bet-modal').classList.add('active');
    }

    async function removeBet(repId, num) {
      const bet=bets.find(b=>b.rep_id===repId&&b.number===num);
      if(bet) await db.from('rr_bets').delete().eq('id',bet.id);
    }

    async function moveBet(repId, fromNum, toNum, tokens) {
      await removeBet(repId, fromNum);
      // Small delay to let realtime update, then place
      setTimeout(()=>placeBet(repId,toNum,tokens), 300);
    }

    function openQuantityModal(repId,num,maxTokens) {
      const rep=reps.find(r=>r.id===repId);
      document.getElementById('bet-modal-num').textContent=num;
      document.getElementById('bet-modal-payout').textContent=`$${PAYOUTS[num]}`;
      document.getElementById('rep-pick-list').innerHTML=`
        <div style="padding:0.4rem 0;font-size:0.88rem;color:var(--text-dim)"><strong style="color:var(--text)">${rep.name}</strong> — how many tokens on ${num}?</div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;padding:0.3rem 0">
          ${Array.from({length:maxTokens},(_,i)=>i+1).map(n=>`<button class="btn" style="flex:1;min-width:40px;font-size:1.1rem;padding:0.55rem" onclick="closeModal('bet-modal');placeBet(${repId},${num},${n})">${n}</button>`).join('')}
        </div>
        <div style="font-size:0.72rem;color:var(--text-dim);margin-top:0.4rem;text-align:center">$${PAYOUTS[num]} payout per token</div>
      `;
      document.getElementById('bet-modal').classList.add('active');
    }

    function openBetModal(num) {
      const eligible=reps.filter(r=>getFreeTokens(r.id)>0);
      if(!eligible.length){alert('No reps have free tokens to bet with.');return;}
      document.getElementById('bet-modal-num').textContent=num;
      document.getElementById('bet-modal-payout').textContent=`$${PAYOUTS[num]}`;
      const list=document.getElementById('rep-pick-list');
      list.innerHTML='';
      eligible.forEach(rep=>{
        const free=getFreeTokens(rep.id);
        const item=document.createElement('div'); item.className='rep-pick-item';
        item.innerHTML=`<div class="rep-avatar" style="background:${rep.color}">${rep.name[0].toUpperCase()}</div><span style="font-weight:700">${rep.name}</span><span class="pick-free">${free} token${free!==1?'s':''}</span>`;
        item.onclick=()=>free===1?(closeModal('bet-modal'),placeBet(rep.id,num,1)):openQuantityModal(rep.id,num,free);
        list.appendChild(item);
      });
      document.getElementById('bet-modal').classList.add('active');
    }

    async function placeBet(repId,num,tokens=1) {
      const existing=bets.find(b=>b.rep_id===repId&&b.number===num);
      if(existing) await db.from('rr_bets').update({tokens:existing.tokens+tokens}).eq('id',existing.id);
      else await db.from('rr_bets').insert({rep_id:repId,number:num,tokens});
    }

    // ==================== REP MANAGEMENT ====================
    function onMyRepChange() {
      const v=document.getElementById('my-rep-select').value;
      myRepId=v?parseInt(v):null;
      renderMyRepBar();
    }

    function openAddRepModal() {
      document.getElementById('new-rep-name').value='';
      document.getElementById('add-rep-modal').classList.add('active');
      setTimeout(()=>document.getElementById('new-rep-name').focus(),100);
    }

    async function addRep() {
      const name=document.getElementById('new-rep-name').value.trim(); if(!name) return;
      const color=REP_COLORS[reps.length%REP_COLORS.length];
      await db.from('rr_reps').insert({name,color,tokens:0,earnings:0});
      closeModal('add-rep-modal');
    }

    async function removeRep(id) {
      await db.from('rr_bets').delete().eq('rep_id',id);
      await db.from('rr_reps').delete().eq('id',id);
      if(myRepId===id) myRepId=null;
    }

    function openGiveTokenModal(id) {
      giveTokenRepId=id;
      const rep=reps.find(r=>r.id===id);
      document.getElementById('give-token-label').innerHTML=`Awarding to <strong>${rep.name}</strong>`;
      document.getElementById('token-reason').value='';
      document.getElementById('give-token-modal').classList.add('active');
    }

    async function confirmGiveToken() {
      const rep=reps.find(r=>r.id===giveTokenRepId); if(!rep) return;
      await db.from('rr_reps').update({tokens:rep.tokens+1}).eq('id',giveTokenRepId);
      closeModal('give-token-modal');
    }

    async function resetAll() {
      if(!confirm('Reset all earnings and tokens? Rep names stay.')) return;
      await db.from('rr_bets').delete().neq('id',0);
      await db.from('rr_history').delete().neq('id',0);
      for(const rep of reps) await db.from('rr_reps').update({tokens:0,earnings:0}).eq('id',rep.id);
      document.getElementById('roll-result').innerHTML='';
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    document.querySelectorAll('.modal-overlay').forEach(o=>{
      o.onclick=e=>{if(e.target===o)o.classList.remove('active');};
    });

    // ==================== BOOT ====================
    initTable();
    loadAll();
    subscribeRealtime();
    updateAdminUI();
  </script>
</body>
</html>
